# ============================================================================
# SELF-LEARNING SPEECH - Babbling to Speech via Feedback
# ============================================================================

CXX = g++
CXXFLAGS = -std=c++17 -O3 -Wall -Wextra -I.
LDFLAGS = -pthread

# Check for PortAudio
PORTAUDIO_LIBS = $(shell pkg-config --libs portaudio-2.0 2>/dev/null || echo "-lportaudio")
PORTAUDIO_CFLAGS = $(shell pkg-config --cflags portaudio-2.0 2>/dev/null)

# Directories
AUDIO_DIR = melvin/audio
CORE_DIR = melvin/core
EXAMPLES_DIR = melvin/examples
BUILD_DIR = build

# Source files
CORE_SOURCES = $(CORE_DIR)/atomic_graph.cpp
AUDIO_SOURCES = $(AUDIO_DIR)/audio_tokenizer.cpp \
                $(AUDIO_DIR)/phoneme_cluster.cpp \
                $(AUDIO_DIR)/phoneme_graph.cpp \
                $(AUDIO_DIR)/vocal_engine.cpp \
                $(AUDIO_DIR)/self_feedback.cpp
EXAMPLE_SOURCE = $(EXAMPLES_DIR)/self_learning_speech.cpp

# Object files
CORE_OBJECTS = $(BUILD_DIR)/atomic_graph.o
AUDIO_OBJECTS = $(BUILD_DIR)/audio_tokenizer.o \
                $(BUILD_DIR)/phoneme_cluster.o \
                $(BUILD_DIR)/phoneme_graph.o \
                $(BUILD_DIR)/vocal_engine.o \
                $(BUILD_DIR)/self_feedback.o

# Target
TARGET = self_learning_speech

# ============================================================================
# MAIN TARGETS
# ============================================================================

.PHONY: all clean run help

all: $(TARGET)
	@echo "âœ… Self-learning speech built successfully"
	@echo "   Babbling â†’ Hearing â†’ Clustering â†’ Adaptation"

$(TARGET): $(CORE_OBJECTS) $(AUDIO_OBJECTS) $(BUILD_DIR)/self_learning_speech.o
	@echo "ðŸ”— Linking self-learning speech..."
	$(CXX) $(CXXFLAGS) $^ -o $@ $(LDFLAGS) $(PORTAUDIO_LIBS)
	@echo "âœ… Built: $@"

# ============================================================================
# OBJECT FILES
# ============================================================================

$(BUILD_DIR)/%.o: $(CORE_DIR)/%.cpp | $(BUILD_DIR)
	@echo "ðŸ”¨ Compiling $<..."
	$(CXX) $(CXXFLAGS) $(PORTAUDIO_CFLAGS) -c $< -o $@

$(BUILD_DIR)/%.o: $(AUDIO_DIR)/%.cpp | $(BUILD_DIR)
	@echo "ðŸ”¨ Compiling $<..."
	$(CXX) $(CXXFLAGS) $(PORTAUDIO_CFLAGS) -c $< -o $@

$(BUILD_DIR)/%.o: $(EXAMPLES_DIR)/%.cpp | $(BUILD_DIR)
	@echo "ðŸ”¨ Compiling $<..."
	$(CXX) $(CXXFLAGS) $(PORTAUDIO_CFLAGS) -c $< -o $@

# ============================================================================
# DIRECTORY CREATION
# ============================================================================

$(BUILD_DIR):
	@mkdir -p $(BUILD_DIR)

# ============================================================================
# CONVENIENCE TARGETS
# ============================================================================

run: $(TARGET)
	@echo ""
	@./$(TARGET) 6

# ============================================================================
# CLEANUP
# ============================================================================

clean:
	@echo "ðŸ§¹ Cleaning build artifacts..."
	rm -rf $(BUILD_DIR)
	rm -f $(TARGET)
	@echo "âœ… Clean complete"

# ============================================================================
# HELP
# ============================================================================

help:
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘  SELF-LEARNING SPEECH - Build System                     â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "Philosophy:"
	@echo "  - Learn phonemes from audio (unsupervised)"
	@echo "  - Hear own voice and adapt"
	@echo "  - Babbling â†’ clustering â†’ synthesis â†’ feedback"
	@echo ""
	@echo "Targets:"
	@echo "  make all      - Build self-learning speech"
	@echo "  make run      - Build and run all demos"
	@echo "  make clean    - Remove build artifacts"
	@echo "  make help     - Show this help"
	@echo ""
	@echo "Demos:"
	@echo "  ./self_learning_speech 1    - Phoneme discovery"
	@echo "  ./self_learning_speech 2    - Self-feedback"
	@echo "  ./self_learning_speech 3    - Phoneme learning"
	@echo "  ./self_learning_speech 4    - Complete cycle"
	@echo "  ./self_learning_speech 5    - Cross-modal"
	@echo "  ./self_learning_speech 6    - Run all"
	@echo ""


