# Makefile for Unified Melvin Brain
# Links ALL brain components: vision, audio, and complete cognitive pipeline

CXX = g++
CXXFLAGS = -std=c++17 -O3 -Wall -I.
LDFLAGS = -L/opt/homebrew/lib -lportaudio -pthread

# ============================================================================
# CORE BRAIN COMPONENTS
# ============================================================================

CORE_OBJS = melvin/core/atomic_graph.o \
            melvin/core/storage.o \
            melvin/core/energy_field.o \
            melvin/core/hopfield_diffusion.o \
            melvin/core/leap_synthesis.o \
            melvin/core/leap_inference.o \
            melvin/core/gnn_predictor.o \
            melvin/core/adaptive_weighting.o \
            melvin/core/episodic_memory.o \
            melvin/core/reasoning.o \
            melvin/core/tokenizer.o \
            melvin/core/learning.o \
            melvin/core/metrics.o \
            melvin/core/attention_manager.o \
            melvin/core/unified_mind.o

# ============================================================================
# AUDIO SUBSYSTEM
# ============================================================================

AUDIO_OBJS = melvin/audio/audio_pipeline.o \
             melvin/audio/audio_bridge.o

# ============================================================================
# VISION SUBSYSTEM
# ============================================================================

VISION_OBJS = melvin/vision/opencv_attention.o \
              melvin/vision/vision_bridge.o

# ============================================================================
# ALL OBJECTS
# ============================================================================

ALL_OBJS = $(CORE_OBJS) $(AUDIO_OBJS) $(VISION_OBJS)

# ============================================================================
# TARGETS
# ============================================================================

.PHONY: all clean test

all: melvin_unified

# Main unified application
melvin_unified: melvin_unified.o $(ALL_OBJS)
	@echo "🔗 Linking unified Melvin brain..."
	$(CXX) $(CXXFLAGS) $^ -o $@ $(LDFLAGS)
	@echo "✅ melvin_unified built successfully!"
	@echo ""
	@echo "Run with: ./melvin_unified"
	@echo ""

# Compile main
melvin_unified.o: melvin_unified.cpp
	@echo "🔨 Compiling melvin_unified.cpp..."
	$(CXX) $(CXXFLAGS) -c $< -o $@

# Core components
melvin/core/%.o: melvin/core/%.cpp melvin/core/%.h
	@echo "🔨 Compiling $<..."
	$(CXX) $(CXXFLAGS) -c $< -o $@

melvin/core/atomic_graph.o: melvin/core/atomic_graph.cpp melvin/core/atomic_graph.h
	@echo "🔨 Compiling atomic_graph..."
	$(CXX) $(CXXFLAGS) -c $< -o $@

melvin/core/storage.o: melvin/core/storage.cpp melvin/core/storage.h
	@echo "🔨 Compiling storage..."
	$(CXX) $(CXXFLAGS) -c $< -o $@

# Audio components
melvin/audio/%.o: melvin/audio/%.cpp melvin/audio/%.h
	@echo "🔨 Compiling $<..."
	$(CXX) $(CXXFLAGS) -c $< -o $@

# Vision components
melvin/vision/%.o: melvin/vision/%.cpp melvin/vision/%.h
	@echo "🔨 Compiling $<..."
	$(CXX) $(CXXFLAGS) -c $< -o $@

# ============================================================================
# UTILITY TARGETS
# ============================================================================

clean:
	@echo "🧹 Cleaning build artifacts..."
	rm -f melvin_unified melvin_unified.o
	rm -f $(ALL_OBJS)
	@echo "✅ Clean complete"

test: melvin_unified
	@echo "🧪 Testing unified Melvin..."
	@echo "Note: This will start camera and microphone."
	@echo "Press Ctrl+C to stop."
	./melvin_unified

info:
	@echo "╔═══════════════════════════════════════════════════════╗"
	@echo "║  🧠 MELVIN UNIFIED BUILD SYSTEM                       ║"
	@echo "╚═══════════════════════════════════════════════════════╝"
	@echo ""
	@echo "Components:"
	@echo "  • Core Brain: EnergyField, Hopfield, LEAPs, GNN, etc."
	@echo "  • Audio: PortAudio + Whisper integration"
	@echo "  • Vision: OpenCV + YOLO (via Python)"
	@echo ""
	@echo "Targets:"
	@echo "  make all    - Build unified Melvin"
	@echo "  make clean  - Remove build artifacts"
	@echo "  make test   - Build and run"
	@echo "  make info   - Show this information"
	@echo ""
	@echo "Dependencies:"
	@echo "  • g++ with C++17 support"
	@echo "  • OpenCV 4.x"
	@echo "  • PortAudio"
	@echo "  • Python 3 + ultralytics (for YOLO)"
	@echo ""

# Help target
help: info

.DEFAULT_GOAL := all

