# ============================================================================
# MELVIN WITH AUDIO - Integration Build
# ============================================================================

CXX = g++
CXXFLAGS = -std=c++17 -O3 -Wall -Wextra -I.
LDFLAGS = -pthread

# Check for PortAudio
PORTAUDIO_LIBS = $(shell pkg-config --libs portaudio-2.0 2>/dev/null || echo "-lportaudio")
PORTAUDIO_CFLAGS = $(shell pkg-config --cflags portaudio-2.0 2>/dev/null)

# Directories
AUDIO_DIR = melvin/audio
CORE_DIR = melvin/core
EXAMPLES_DIR = melvin/examples
BUILD_DIR = build

# Source files
CORE_SOURCES = $(CORE_DIR)/atomic_graph.cpp
AUDIO_SOURCES = $(AUDIO_DIR)/audio_pipeline.cpp $(AUDIO_DIR)/audio_bridge.cpp
EXAMPLE_SOURCE = $(EXAMPLES_DIR)/melvin_with_audio.cpp

# Object files
CORE_OBJECTS = $(BUILD_DIR)/atomic_graph.o
AUDIO_OBJECTS = $(BUILD_DIR)/audio_pipeline.o $(BUILD_DIR)/audio_bridge.o
EXAMPLE_OBJECT = $(BUILD_DIR)/melvin_with_audio.o

# Target
TARGET = melvin_with_audio

# ============================================================================
# MAIN TARGETS
# ============================================================================

.PHONY: all clean run test-audio help

all: $(TARGET)
	@echo "âœ… Integration example built successfully"
	@echo "Run with: ./$(TARGET)"

$(TARGET): $(CORE_OBJECTS) $(AUDIO_OBJECTS) $(EXAMPLE_OBJECT)
	@echo "ğŸ”— Linking integration example..."
	$(CXX) $(CXXFLAGS) $^ -o $@ $(LDFLAGS) $(PORTAUDIO_LIBS)
	@echo "âœ… Built: $@"

# ============================================================================
# OBJECT FILES
# ============================================================================

$(BUILD_DIR)/%.o: $(CORE_DIR)/%.cpp | $(BUILD_DIR)
	@echo "ğŸ”¨ Compiling $<..."
	$(CXX) $(CXXFLAGS) $(PORTAUDIO_CFLAGS) -c $< -o $@

$(BUILD_DIR)/%.o: $(AUDIO_DIR)/%.cpp | $(BUILD_DIR)
	@echo "ğŸ”¨ Compiling $<..."
	$(CXX) $(CXXFLAGS) $(PORTAUDIO_CFLAGS) -c $< -o $@

$(BUILD_DIR)/%.o: $(EXAMPLES_DIR)/%.cpp | $(BUILD_DIR)
	@echo "ğŸ”¨ Compiling $<..."
	$(CXX) $(CXXFLAGS) $(PORTAUDIO_CFLAGS) -c $< -o $@

# ============================================================================
# DIRECTORY CREATION
# ============================================================================

$(BUILD_DIR):
	@mkdir -p $(BUILD_DIR)

# ============================================================================
# CONVENIENCE TARGETS
# ============================================================================

run: $(TARGET)
	@echo ""
	@echo "ğŸš€ Starting Melvin with Audio..."
	@echo ""
	@./$(TARGET)

test-audio: $(TARGET)
	@echo "ğŸ§ª Testing audio integration (10 seconds)..."
	@timeout 10 ./$(TARGET) || true

check-deps:
	@echo "ğŸ” Checking dependencies..."
	@echo ""
	@echo "PortAudio:"
	@pkg-config --exists portaudio-2.0 && echo "  âœ… Found" || echo "  âŒ Not found"
	@echo ""
	@echo "Python packages:"
	@python3 -c "import whisper; print('  âœ… Whisper')" 2>/dev/null || echo "  âš ï¸  Whisper not installed"
	@python3 -c "import librosa; print('  âœ… Librosa')" 2>/dev/null || echo "  âš ï¸  Librosa not installed"
	@echo ""

install-deps:
	@echo "ğŸ“¦ Installing audio dependencies..."
	@bash setup_audio_deps.sh

# ============================================================================
# CLEANUP
# ============================================================================

clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -rf $(BUILD_DIR)
	rm -f $(TARGET)
	rm -f melvin_nodes.bin melvin_edges.bin
	@echo "âœ… Clean complete"

# ============================================================================
# HELP
# ============================================================================

help:
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘  MELVIN WITH AUDIO - Build System                        â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "Targets:"
	@echo "  make all           - Build integration example"
	@echo "  make run           - Build and run Melvin with audio"
	@echo "  make test-audio    - Test audio integration (10s)"
	@echo "  make check-deps    - Check required dependencies"
	@echo "  make install-deps  - Install Python dependencies"
	@echo "  make clean         - Remove build artifacts"
	@echo "  make help          - Show this help message"
	@echo ""
	@echo "Examples:"
	@echo "  make all && ./melvin_with_audio"
	@echo "  make run"
	@echo ""

# ============================================================================
# DEPENDENCIES
# ============================================================================

-include $(CORE_OBJECTS:.o=.d)
-include $(AUDIO_OBJECTS:.o=.d)
-include $(EXAMPLE_OBJECT:.o=.d)

