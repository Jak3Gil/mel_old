# ============================================================================
# MELVIN UCA v1 - Unified Cognitive Architecture
# Makefile for brain-inspired AI system
# ============================================================================

CXX = g++
CXXFLAGS = -std=gnu++20 -O2 -Wall -Wextra -pedantic -march=native -I./include
LDFLAGS = -pthread

# Directories
INC_DIR = include
SRC_DIR = src
TEST_DIR = tests
BUILD_DIR = build
OBJ_DIR = $(BUILD_DIR)/obj

# Source files (exclude main_unified.cpp for library)
SOURCES = $(filter-out $(SRC_DIR)/main_unified.cpp, $(wildcard $(SRC_DIR)/*.cpp))
OBJECTS = $(patsubst $(SRC_DIR)/%.cpp,$(OBJ_DIR)/%.o,$(SOURCES))

# Targets
TARGET = $(BUILD_DIR)/test_uca_system
MAIN_TARGET = $(BUILD_DIR)/melvin_uca

.PHONY: all run test clean format help

all: $(TARGET)

# Build test program
$(TARGET): $(OBJECTS) $(TEST_DIR)/test_uca_system.cpp | $(BUILD_DIR)
	@echo "ğŸ”§ Building test program..."
	$(CXX) $(CXXFLAGS) $(OBJECTS) $(TEST_DIR)/test_uca_system.cpp -o $@ $(LDFLAGS)
	@echo "âœ… Built: $@"

# Build main program (optional)
main: $(OBJECTS) $(SRC_DIR)/main_unified.cpp | $(BUILD_DIR)
	@echo "ğŸ”§ Building main program..."
	$(CXX) $(CXXFLAGS) $(OBJECTS) $(SRC_DIR)/main_unified.cpp -o $(MAIN_TARGET) $(LDFLAGS)
	@echo "âœ… Built: $(MAIN_TARGET)"

# Compile object files
$(OBJ_DIR)/%.o: $(SRC_DIR)/%.cpp | $(OBJ_DIR)
	@echo "ğŸ“¦ Compiling $<..."
	@$(CXX) $(CXXFLAGS) -c $< -o $@

# Create directories
$(BUILD_DIR):
	@mkdir -p $(BUILD_DIR)

$(OBJ_DIR):
	@mkdir -p $(OBJ_DIR)

# Run tests
run: $(TARGET)
	@echo "ğŸ§ª Running UCA test suite..."
	@./$(TARGET)

test: run

# Clean build artifacts
clean:
	@echo "ğŸ§¹ Cleaning..."
	@rm -rf $(BUILD_DIR)
	@echo "âœ… Clean complete"

# Format code (if clang-format available)
format:
	@echo "ğŸ“ Formatting code..."
	@find $(INC_DIR) $(SRC_DIR) $(TEST_DIR) -name "*.h" -o -name "*.cpp" | xargs clang-format -i 2>/dev/null || echo "clang-format not available"

# Help
help:
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘  ğŸ§  MELVIN UCA v1 - Build System                                  â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "TARGETS:"
	@echo "  make              Build test program"
	@echo "  make run          Build and run tests"
	@echo "  make test         Same as 'make run'"
	@echo "  make main         Build main program (optional)"
	@echo "  make clean        Remove build artifacts"
	@echo "  make format       Format code with clang-format"
	@echo "  make help         Show this help"
	@echo ""
	@echo "ARCHITECTURE:"
	@echo "  â€¢ melvin_types.h      Core data structures"
	@echo "  â€¢ melvin_graph.*      AtomicGraph (Hippocampus + Cortex)"
	@echo "  â€¢ melvin_vision.*     Vision pipeline (V1â†’V4â†’IT)"
	@echo "  â€¢ melvin_focus.*      Attention control (FEF/SC)"
	@echo "  â€¢ melvin_reasoning.*  PFC reasoning"
	@echo "  â€¢ melvin_reflect.*    Predictive coding"
	@echo "  â€¢ melvin_output.*     Motor/Speech output"
	@echo "  â€¢ unified_mind.*      Complete orchestrator"
	@echo ""
	@echo "COGNITIVE LOOP:"
	@echo "  INPUT â†’ PERCEPTION â†’ ATTENTION â†’ REASONING â†’ REFLECTION â†’ OUTPUT"
	@echo "     â†‘                                                        â†“"
	@echo "     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ FEEDBACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
	@echo ""
	@echo "TEST SUITE (6 demos):"
	@echo "  1. Tokenize & Link       - Frame/patch creation, temporal edges"
	@echo "  2. Gestalt Group         - Object formation from patches"
	@echo "  3. Saliency vs Goal      - Attention scoring (Î±*S + Î²*G + Î³*C)"
	@echo "  4. Reasoning Hop         - Multi-hop graph inference"
	@echo "  5. Predictive Error      - Prediction error â†’ learning â†’ LEAPs"
	@echo "  6. Closed Loop           - 100 complete cognitive cycles"
	@echo ""
	@echo "CONSTANTS:"
	@echo "  Î± (saliency) = 0.45,  Î² (goal) = 0.35,  Î³ (curiosity) = 0.20"
	@echo "  Î» (decay) = 0.0025/s,  Î· (reinforce) = 0.10"
	@echo ""

# Show build info
info:
	@echo "Source files: $(SOURCES)"
	@echo "Object files: $(OBJECTS)"
	@echo "Compiler: $(CXX)"
	@echo "Flags: $(CXXFLAGS)"
